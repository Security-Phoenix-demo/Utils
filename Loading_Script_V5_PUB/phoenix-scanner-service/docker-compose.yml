services:
  # ============================================================================
  # Redis - Message broker and result backend
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: phoenix-scanner-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - phoenix-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # PostgreSQL - Job database (optional, can use SQLite)
  # ============================================================================
  # Uncomment to use PostgreSQL instead of SQLite
  # postgres:
  #   image: postgres:15-alpine
  #   container_name: phoenix-scanner-postgres
  #   environment:
  #     POSTGRES_USER: phoenix
  #     POSTGRES_PASSWORD: phoenix_secure_password
  #     POSTGRES_DB: phoenix_scanner
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - phoenix-network
  #   healthcheck:
  #     test: ["CMD-SHELL", "pg_isready -U phoenix"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   restart: unless-stopped

  # ============================================================================
  # API Service - FastAPI REST API
  # ============================================================================
  api:
    build:
      context: ..
      dockerfile: phoenix-scanner-service/Dockerfile
      target: api
    container_name: phoenix-scanner-api
    environment:
      # API Configuration
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8000}
      - API_WORKERS=${API_WORKERS:-4}
      
      # Security
      - API_KEY=${API_KEY:-changeme-insecure-key}
      - SECRET_KEY=${SECRET_KEY:-changeme-secret-key}
      - ENABLE_AUTH=${ENABLE_AUTH:-true}
      
      # Redis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      
      # Database (SQLite default)
      - DATABASE_URL=${DATABASE_URL:-sqlite:////app/data/jobs.db}
      # Use PostgreSQL:
      # - DATABASE_URL=postgresql://phoenix:phoenix_secure_password@postgres:5432/phoenix_scanner
      
      # File Storage
      - UPLOAD_DIR=${UPLOAD_DIR:-/app/uploads}
      - LOG_DIR=${LOG_DIR:-/app/logs}
      - MAX_UPLOAD_SIZE_MB=${MAX_UPLOAD_SIZE_MB:-500}
      
      # Worker Settings
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-5}
      - JOB_TIMEOUT=${JOB_TIMEOUT:-3600}
      
      # Phoenix Scanner
      - PHOENIX_CONFIG_FILE=${PHOENIX_CONFIG_FILE:-/parent/config_multi_scanner.ini}
      - PHOENIX_CLIENT_ID=${PHOENIX_CLIENT_ID:-}
      - PHOENIX_CLIENT_SECRET=${PHOENIX_CLIENT_SECRET:-}
      - PHOENIX_API_URL=${PHOENIX_API_URL:-}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG_MODE=${DEBUG_MODE:-false}
    ports:
      # Maps host port to container port (both configurable via .env)
      # Host port: PHOENIX_API_HOST_PORT (default: 8001)
      # Container port: API_PORT (default: 8000)
      - "${PHOENIX_API_HOST_PORT:-8001}:${API_PORT:-8000}"
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./data:/app/data
      # Mount parent directory for Phoenix importer
      - ../:/parent:ro
    networks:
      - phoenix-network
    depends_on:
      redis:
        condition: service_healthy
      # postgres:
      #   condition: service_healthy
    healthcheck:
      test: ["CMD", "sh", "-c", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:$${API_PORT:-8000}/api/v1/ping')\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ============================================================================
  # Worker Service - Celery workers for background processing
  # ============================================================================
  worker:
    build:
      context: ..
      dockerfile: phoenix-scanner-service/Dockerfile
      target: worker
    # Note: No container_name when using replicas - Docker will auto-generate names
    environment:
      # Redis
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      
      # Database
      - DATABASE_URL=${DATABASE_URL:-sqlite:////app/data/jobs.db}
      # Use PostgreSQL:
      # - DATABASE_URL=postgresql://phoenix:phoenix_secure_password@postgres:5432/phoenix_scanner
      
      # File Storage
      - UPLOAD_DIR=${UPLOAD_DIR:-/app/uploads}
      - LOG_DIR=${LOG_DIR:-/app/logs}
      
      # Phoenix Credentials (from environment)
      - PHOENIX_CLIENT_ID=${PHOENIX_CLIENT_ID:-}
      - PHOENIX_CLIENT_SECRET=${PHOENIX_CLIENT_SECRET:-}
      - PHOENIX_API_URL=${PHOENIX_API_URL:-}
      
      # Worker Settings
      - MAX_CONCURRENT_JOBS=${MAX_CONCURRENT_JOBS:-5}
      - JOB_TIMEOUT=${JOB_TIMEOUT:-3600}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./data:/app/data
      # Mount parent directory for Phoenix importer
      - ../:/parent:ro
    networks:
      - phoenix-network
    depends_on:
      redis:
        condition: service_healthy
      api:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 2  # Run 2 worker instances for better throughput

  # ============================================================================
  # Flower - Celery monitoring (optional)
  # ============================================================================
  flower:
    image: mher/flower:2.0
    container_name: phoenix-scanner-flower
    command: celery --broker=redis://redis:6379/0 flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    networks:
      - phoenix-network
    depends_on:
      - redis
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================
networks:
  phoenix-network:
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================
volumes:
  redis_data:
    driver: local
  # postgres_data:
  #   driver: local

