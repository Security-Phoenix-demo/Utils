#!/usr/bin/env python3
"""
Vulnerability Executive Report Generator (Simplified)

This script analyzes vulnerability data and generates comprehensive executive reports
with trend analysis, top threats, and security insights using only standard libraries.

Author: Phoenix Security Configuration System
Version: 1.0
Date: 2025
"""

import pandas as pd
import csv
import json
from datetime import datetime
from collections import defaultdict, Counter
import os

class VulnerabilityAnalyzer:
    def __init__(self, csv_file_path):
        """Initialize the analyzer with CSV data"""
        self.df = pd.read_csv(csv_file_path)
        self.setup_data()
        
    def setup_data(self):
        """Clean and prepare data for analysis"""
        # Convert numeric columns
        numeric_cols = ['stats_risk', 'stats_riskMagnitude', 'stats_findingsCount', 
                       'stats_assetsCount', 'stats_findingStats_open', 'stats_findingStats_closed',
                       'stats_findingStats_critical', 'stats_findingStats_high', 
                       'stats_findingStats_medium', 'stats_findingStats_low']
        
        for col in numeric_cols:
            if col in self.df.columns:
                self.df[col] = pd.to_numeric(self.df[col], errors='coerce').fillna(0)
        
        # Extract CVE year from name
        self.df['cve_year'] = self.df['name'].str.extract(r'CVE-(\d{4})').astype(float)
        
        # Calculate total severity
        self.df['total_severity_count'] = (self.df['stats_findingStats_critical'] + 
                                         self.df['stats_findingStats_high'] + 
                                         self.df['stats_findingStats_medium'] + 
                                         self.df['stats_findingStats_low'])
        
        # Create severity category
        self.df['primary_severity'] = self.df.apply(self._get_primary_severity, axis=1)
        
    def _get_primary_severity(self, row):
        """Determine primary severity level for each vulnerability"""
        if row['stats_findingStats_critical'] > 0:
            return 'Critical'
        elif row['stats_findingStats_high'] > 0:
            return 'High'
        elif row['stats_findingStats_medium'] > 0:
            return 'Medium'
        elif row['stats_findingStats_low'] > 0:
            return 'Low'
        else:
            return 'Unknown'
            
    def generate_executive_summary(self):
        """Generate executive summary statistics"""
        total_vulns = len(self.df)
        total_assets_affected = self.df['stats_assetsCount'].sum()
        total_findings = self.df['stats_findingsCount'].sum()
        avg_risk_score = self.df['stats_risk'].mean()
        
        critical_vulns = (self.df['stats_findingStats_critical'] > 0).sum()
        high_vulns = (self.df['stats_findingStats_high'] > 0).sum()
        
        open_findings = self.df['stats_findingStats_open'].sum()
        closed_findings = self.df['stats_findingStats_closed'].sum()
        
        summary = {
            'total_vulnerabilities': total_vulns,
            'total_assets_affected': int(total_assets_affected),
            'total_findings': int(total_findings),
            'average_risk_score': round(avg_risk_score, 1),
            'critical_vulnerabilities': critical_vulns,
            'high_vulnerabilities': high_vulns,
            'open_findings': int(open_findings),
            'closed_findings': int(closed_findings),
            'remediation_rate': round((closed_findings / (open_findings + closed_findings)) * 100, 1) if (open_findings + closed_findings) > 0 else 0
        }
        
        return summary
        
    def get_top_vulnerabilities(self, top_n=10):
        """Get top vulnerabilities by various criteria"""
        # Top by risk score
        top_risk = self.df.nlargest(top_n, 'stats_risk')[['name', 'stats_risk', 'stats_findingsCount', 'stats_assetsCount']]
        
        # Top by asset count
        top_assets = self.df.nlargest(top_n, 'stats_assetsCount')[['name', 'stats_assetsCount', 'stats_risk', 'stats_findingsCount']]
        
        # Top by findings count
        top_findings = self.df.nlargest(top_n, 'stats_findingsCount')[['name', 'stats_findingsCount', 'stats_assetsCount', 'stats_risk']]
        
        return {
            'top_risk': top_risk,
            'top_assets': top_assets,
            'top_findings': top_findings
        }
        
    def analyze_ransomware_threats(self):
        """Identify potential ransomware-related vulnerabilities"""
        # Common ransomware CVEs (based on known patterns)
        ransomware_indicators = [
            'CVE-2021-44228',  # Log4j
            'CVE-2021-45046',  # Log4j
            'CVE-2017-11882',  # Office
            'CVE-2020-1147',   # NET Framework
            'CVE-2021-4034',   # PwnKit
            'CVE-2022-0847',   # DirtyPipe
            'CVE-2023-4911',   # Looney Tunables
            'CVE-2023-4863',   # Chrome/WebP
            'CVE-2022-37434',  # zlib
            'CVE-2007-4559',   # Python tarfile
        ]
        
        ransomware_vulns = self.df[self.df['name'].isin(ransomware_indicators)]
        
        # Also look for high-risk vulnerabilities that could be exploited
        high_risk_vulns = self.df[
            (self.df['stats_risk'] >= 900) & 
            (self.df['stats_findingStats_critical'] > 0)
        ].nlargest(15, 'stats_risk')
        
        return {
            'known_ransomware': ransomware_vulns,
            'high_risk_exploitable': high_risk_vulns
        }
        
    def analyze_application_trends(self):
        """Analyze trends in application vulnerabilities"""
        # Group by finding types
        finding_types_data = []
        for _, row in self.df.iterrows():
            types = str(row['stats_findingTypes']).split(';') if pd.notna(row['stats_findingTypes']) else ['Unknown']
            for ftype in types:
                finding_types_data.append({
                    'type': ftype.strip(),
                    'risk': row['stats_risk'],
                    'findings': row['stats_findingsCount'],
                    'assets': row['stats_assetsCount'],
                    'critical': row['stats_findingStats_critical'],
                    'high': row['stats_findingStats_high']
                })
        
        # Aggregate by application type
        app_summary = defaultdict(lambda: {'risk_total': 0, 'findings': 0, 'assets': 0, 'critical': 0, 'high': 0, 'count': 0})
        
        for item in finding_types_data:
            app_type = item['type']
            app_summary[app_type]['risk_total'] += item['risk']
            app_summary[app_type]['findings'] += item['findings']
            app_summary[app_type]['assets'] += item['assets']
            app_summary[app_type]['critical'] += item['critical']
            app_summary[app_type]['high'] += item['high']
            app_summary[app_type]['count'] += 1
        
        # Calculate averages
        app_trends = {}
        for app_type, data in app_summary.items():
            app_trends[app_type] = {
                'average_risk': round(data['risk_total'] / data['count'], 1),
                'total_findings': data['findings'],
                'total_assets': data['assets'],
                'critical_count': data['critical'],
                'high_count': data['high']
            }
        
        return app_trends
        
    def analyze_time_trends(self):
        """Analyze vulnerability trends over time"""
        # Group by CVE year
        year_summary = defaultdict(lambda: {'risk_total': 0, 'findings': 0, 'assets': 0, 'critical': 0, 'high': 0, 'count': 0})
        
        for _, row in self.df.iterrows():
            year = row['cve_year'] if pd.notna(row['cve_year']) else 'Unknown'
            year_summary[year]['risk_total'] += row['stats_risk']
            year_summary[year]['findings'] += row['stats_findingsCount']
            year_summary[year]['assets'] += row['stats_assetsCount']
            year_summary[year]['critical'] += row['stats_findingStats_critical']
            year_summary[year]['high'] += row['stats_findingStats_high']
            year_summary[year]['count'] += 1
        
        # Calculate averages and sort by year
        year_trends = {}
        for year, data in year_summary.items():
            year_trends[year] = {
                'average_risk': round(data['risk_total'] / data['count'], 1),
                'total_findings': data['findings'],
                'total_assets': data['assets'],
                'critical_count': data['critical'],
                'high_count': data['high'],
                'vulnerability_count': data['count']
            }
        
        return year_trends
        
    def generate_severity_distribution(self):
        """Generate severity distribution analysis"""
        severity_data = {
            'Critical': int(self.df['stats_findingStats_critical'].sum()),
            'High': int(self.df['stats_findingStats_high'].sum()),
            'Medium': int(self.df['stats_findingStats_medium'].sum()),
            'Low': int(self.df['stats_findingStats_low'].sum())
        }
        
        return severity_data
        
    def analyze_team_impact(self):
        """Analyze which teams/applications are most affected"""
        # Based on finding sources and types
        team_impact = defaultdict(lambda: {'vulnerabilities': 0, 'total_risk': 0, 'assets': 0, 'critical': 0})
        
        for _, row in self.df.iterrows():
            source = str(row['stats_findingSources']) if pd.notna(row['stats_findingSources']) else 'Unknown'
            team_impact[source]['vulnerabilities'] += 1
            team_impact[source]['total_risk'] += row['stats_risk']
            team_impact[source]['assets'] += row['stats_assetsCount']
            team_impact[source]['critical'] += row['stats_findingStats_critical']
        
        # Convert to regular dict and calculate averages
        team_results = {}
        for team, data in team_impact.items():
            team_results[team] = {
                'vulnerabilities': data['vulnerabilities'],
                'average_risk': round(data['total_risk'] / data['vulnerabilities'], 1),
                'total_assets': data['assets'],
                'critical_findings': data['critical']
            }
        
        return team_results
        
    def generate_html_report(self):
        """Generate comprehensive HTML executive report"""
        
        summary = self.generate_executive_summary()
        top_vulns = self.get_top_vulnerabilities()
        ransomware = self.analyze_ransomware_threats()
        app_trends = self.analyze_application_trends()
        time_trends = self.analyze_time_trends()
        severity_dist = self.generate_severity_distribution()
        team_impact = self.analyze_team_impact()
        
        html_content = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Vulnerability Executive Report</title>
    <style>
        body {{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }}
        .container {{ max-width: 1400px; margin: 0 auto; background-color: white; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }}
        .header {{ background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 40px; text-align: center; position: relative; }}
        .header h1 {{ margin: 0; font-size: 2.5em; font-weight: 300; }}
        .header .subtitle {{ font-size: 1.2em; opacity: 0.9; margin-top: 10px; }}
        .logo-container {{ display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }}
        .logo {{ max-width: 200px; max-height: 120px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }}
        .phoenix-branding {{ display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 30px; }}
        .phoenix-text {{ font-size: 1.8em; font-weight: 600; letter-spacing: 2px; }}
        .phoenix-orange {{ color: #FF6B35; }}
        .footer-logo {{ max-width: 150px; max-height: 80px; opacity: 0.8; }}
        .content {{ padding: 40px; }}
        .section {{ margin-bottom: 40px; }}
        .metric-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin: 30px 0; }}
        .metric-card {{ padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.1); transition: transform 0.3s ease; }}
        .metric-card:hover {{ transform: translateY(-5px); }}
        .metric-value {{ font-size: 2.5em; font-weight: bold; margin-bottom: 10px; }}
        .metric-label {{ font-size: 1.1em; opacity: 0.9; }}
        .card-blue {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }}
        .card-red {{ background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; }}
        .card-orange {{ background: linear-gradient(135deg, #ffa726 0%, #ff7043 100%); color: white; }}
        .card-green {{ background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); color: white; }}
        .card-purple {{ background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%); color: white; }}
        .card-teal {{ background: linear-gradient(135deg, #26a69a 0%, #00695c 100%); color: white; }}
        table {{ width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }}
        th {{ background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); color: white; padding: 15px; text-align: left; font-weight: 600; }}
        td {{ padding: 12px 15px; border-bottom: 1px solid #ecf0f1; }}
        tr:nth-child(even) {{ background-color: #f8f9fa; }}
        tr:hover {{ background-color: #e3f2fd; }}
        .highlight {{ background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-left: 5px solid #ff9800; padding: 20px; margin: 20px 0; border-radius: 8px; }}
        .alert {{ background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); border-left: 5px solid #f44336; padding: 20px; margin: 20px 0; border-radius: 8px; }}
        .success {{ background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%); border-left: 5px solid #4caf50; padding: 20px; margin: 20px 0; border-radius: 8px; }}
        h1, h2, h3 {{ color: #2c3e50; }}
        h2 {{ border-bottom: 3px solid #3498db; padding-bottom: 15px; margin-bottom: 25px; font-size: 1.8em; }}
        h3 {{ color: #34495e; margin-bottom: 15px; }}
        .timestamp {{ color: #7f8c8d; font-style: italic; }}
        .risk-high {{ color: #e74c3c; font-weight: bold; }}
        .risk-medium {{ color: #f39c12; font-weight: bold; }}
        .risk-low {{ color: #27ae60; font-weight: bold; }}
        .cve-link {{ color: #3498db; text-decoration: none; }}
        .cve-link:hover {{ text-decoration: underline; }}
        .summary-text {{ font-size: 1.1em; line-height: 1.6; color: #555; }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="../logos/Stacked Black White CONTRAST Purple NOTEXT.jpg" alt="Phoenix Security Logo" class="logo">
            </div>
            <div class="phoenix-branding">
                <span class="phoenix-text">PHOENIX <span class="phoenix-orange">SECURITY</span></span>
            </div>
            <h1>üõ°Ô∏è Vulnerability Executive Report</h1>
            <div class="subtitle">Comprehensive Security Assessment & Analysis</div>
            <div class="timestamp">Generated on {datetime.now().strftime('%B %d, %Y at %H:%M:%S')}</div>
        </div>

        <div class="content">
            <div class="section">
                <h2>üìä Executive Summary</h2>
                <div class="summary-text">
                    <p>This comprehensive vulnerability assessment reveals critical security insights across your infrastructure. 
                    Our analysis covers <strong>{summary['total_vulnerabilities']:,} vulnerabilities</strong> affecting 
                    <strong>{summary['total_assets_affected']:,} assets</strong> with a total of 
                    <strong>{summary['total_findings']:,} findings</strong>.</p>
                </div>
                
                <div class="metric-grid">
                    <div class="metric-card card-blue">
                        <div class="metric-value">{summary['total_vulnerabilities']:,}</div>
                        <div class="metric-label">Total Vulnerabilities</div>
                    </div>
                    <div class="metric-card card-red">
                        <div class="metric-value">{summary['critical_vulnerabilities']}</div>
                        <div class="metric-label">Critical Vulnerabilities</div>
                    </div>
                    <div class="metric-card card-orange">
                        <div class="metric-value">{summary['high_vulnerabilities']}</div>
                        <div class="metric-label">High Risk Vulnerabilities</div>
                    </div>
                    <div class="metric-card card-purple">
                        <div class="metric-value">{summary['total_assets_affected']:,}</div>
                        <div class="metric-label">Assets Affected</div>
                    </div>
                    <div class="metric-card card-teal">
                        <div class="metric-value">{summary['average_risk_score']}</div>
                        <div class="metric-label">Average Risk Score</div>
                    </div>
                    <div class="metric-card card-green">
                        <div class="metric-value">{summary['remediation_rate']}%</div>
                        <div class="metric-label">Remediation Rate</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üö® Top Critical Vulnerabilities</h2>
                <div class="alert">
                    <strong>‚ö†Ô∏è Immediate Action Required:</strong> These vulnerabilities pose the highest risk to your organization and require urgent remediation.
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>CVE ID</th>
                            <th>Risk Score</th>
                            <th>Findings</th>
                            <th>Assets Affected</th>
                            <th>Risk Level</th>
                        </tr>
                    </thead>
                    <tbody>
"""
        
        for _, vuln in top_vulns['top_risk'].head(15).iterrows():
            risk_class = 'risk-high' if vuln['stats_risk'] >= 900 else 'risk-medium' if vuln['stats_risk'] >= 700 else 'risk-low'
            html_content += f"""
                        <tr>
                            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name={vuln['name']}" class="cve-link" target="_blank">{vuln['name']}</a></td>
                            <td><span class="{risk_class}">{vuln['stats_risk']:.0f}</span></td>
                            <td>{vuln['stats_findingsCount']:.0f}</td>
                            <td>{vuln['stats_assetsCount']:.0f}</td>
                            <td><span class="{risk_class}">{'CRITICAL' if vuln['stats_risk'] >= 900 else 'HIGH' if vuln['stats_risk'] >= 700 else 'MEDIUM'}</span></td>
                        </tr>
"""
        
        html_content += """
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>üîí Ransomware & High-Impact Threats</h2>
                <div class="alert">
                    <strong>üéØ Critical Security Alert:</strong> The following vulnerabilities are commonly exploited in ransomware attacks and advanced persistent threats (APTs).
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>CVE ID</th>
                            <th>Risk Score</th>
                            <th>Critical Findings</th>
                            <th>Assets at Risk</th>
                            <th>Threat Type</th>
                        </tr>
                    </thead>
                    <tbody>
"""
        
        ransomware_cves = ['CVE-2021-44228', 'CVE-2021-45046', 'CVE-2020-1147', 'CVE-2021-4034', 'CVE-2022-0847', 'CVE-2023-4911']
        
        for _, vuln in ransomware['high_risk_exploitable'].head(15).iterrows():
            threat_type = "Known Ransomware CVE" if vuln['name'] in ransomware_cves else "High-Risk Exploitable"
            html_content += f"""
                        <tr>
                            <td><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name={vuln['name']}" class="cve-link" target="_blank">{vuln['name']}</a></td>
                            <td><span class="risk-high">{vuln['stats_risk']:.0f}</span></td>
                            <td>{vuln['stats_findingStats_critical']:.0f}</td>
                            <td>{vuln['stats_assetsCount']:.0f}</td>
                            <td>{threat_type}</td>
                        </tr>
"""
        
        html_content += """
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>üì± Application & Infrastructure Trends</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Application Type</th>
                            <th>Average Risk Score</th>
                            <th>Total Findings</th>
                            <th>Assets Affected</th>
                            <th>Critical Issues</th>
                        </tr>
                    </thead>
                    <tbody>
"""
        
        # Sort application trends by risk score
        sorted_apps = sorted(app_trends.items(), key=lambda x: x[1]['average_risk'], reverse=True)
        
        for app_type, data in sorted_apps:
            risk_class = 'risk-high' if data['average_risk'] >= 700 else 'risk-medium' if data['average_risk'] >= 500 else 'risk-low'
            html_content += f"""
                        <tr>
                            <td><strong>{app_type}</strong></td>
                            <td><span class="{risk_class}">{data['average_risk']}</span></td>
                            <td>{data['total_findings']}</td>
                            <td>{data['total_assets']}</td>
                            <td>{data['critical_count']}</td>
                        </tr>
"""
        
        html_content += """
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>üìà Vulnerability Trends Over Time</h2>
                <table>
                    <thead>
                        <tr>
                            <th>CVE Year</th>
                            <th>Vulnerabilities</th>
                            <th>Average Risk</th>
                            <th>Total Findings</th>
                            <th>Critical Count</th>
                            <th>High Count</th>
                        </tr>
                    </thead>
                    <tbody>
"""
        
        # Sort by year (most recent first)
        sorted_years = sorted(time_trends.items(), key=lambda x: x[0] if x[0] != 'Unknown' else 0, reverse=True)
        
        for year, data in sorted_years[:15]:  # Show last 15 years
            year_display = int(year) if year != 'Unknown' else 'Unknown'
            risk_class = 'risk-high' if data['average_risk'] >= 700 else 'risk-medium' if data['average_risk'] >= 500 else 'risk-low'
            html_content += f"""
                        <tr>
                            <td><strong>{year_display}</strong></td>
                            <td>{data['vulnerability_count']}</td>
                            <td><span class="{risk_class}">{data['average_risk']}</span></td>
                            <td>{data['total_findings']}</td>
                            <td>{data['critical_count']}</td>
                            <td>{data['high_count']}</td>
                        </tr>
"""
        
        html_content += """
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>üìä Severity Distribution Analysis</h2>
                <div class="metric-grid">
"""
        
        for severity, count in severity_dist.items():
            card_class = 'card-red' if severity == 'Critical' else 'card-orange' if severity == 'High' else 'card-blue' if severity == 'Medium' else 'card-green'
            html_content += f"""
                    <div class="metric-card {card_class}">
                        <div class="metric-value">{count:,}</div>
                        <div class="metric-label">{severity} Severity</div>
                    </div>
"""
        
        html_content += """
                </div>
            </div>

            <div class="section">
                <h2>üë• Team Impact Analysis</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Team/Source</th>
                            <th>Vulnerabilities</th>
                            <th>Average Risk</th>
                            <th>Total Assets</th>
                            <th>Critical Findings</th>
                        </tr>
                    </thead>
                    <tbody>
"""
        
        # Sort teams by number of vulnerabilities
        sorted_teams = sorted(team_impact.items(), key=lambda x: x[1]['vulnerabilities'], reverse=True)
        
        for team, data in sorted_teams:
            risk_class = 'risk-high' if data['average_risk'] >= 700 else 'risk-medium' if data['average_risk'] >= 500 else 'risk-low'
            html_content += f"""
                        <tr>
                            <td><strong>{team}</strong></td>
                            <td>{data['vulnerabilities']}</td>
                            <td><span class="{risk_class}">{data['average_risk']}</span></td>
                            <td>{data['total_assets']}</td>
                            <td>{data['critical_findings']}</td>
                        </tr>
"""
        
        html_content += """
                    </tbody>
                </table>
            </div>

            <div class="section">
                <h2>üéØ Strategic Recommendations</h2>
                
                <div class="alert">
                    <h3>üö® Immediate Actions (Next 7 Days)</h3>
                    <ul>
                        <li><strong>Critical Priority:</strong> Address all vulnerabilities with risk scores ‚â• 900</li>
                        <li><strong>Patch Management:</strong> Deploy security updates for Log4j, OpenSSL, and container vulnerabilities</li>
                        <li><strong>Asset Isolation:</strong> Isolate assets with multiple critical vulnerabilities</li>
                        <li><strong>Monitoring:</strong> Implement 24/7 monitoring for ransomware indicators</li>
                    </ul>
                </div>
                
                <div class="highlight">
                    <h3>üìã Short-term Actions (Next 30 Days)</h3>
                    <ul>
                        <li><strong>Remediation Plan:</strong> Develop timeline for all High severity vulnerabilities</li>
                        <li><strong>Cloud Security:</strong> Strengthen CLOUD and CONTAINER environment security</li>
                        <li><strong>Vulnerability Scanning:</strong> Increase scan frequency for critical assets</li>
                        <li><strong>Incident Response:</strong> Update playbooks for identified threat vectors</li>
                    </ul>
                </div>
                
                <div class="success">
                    <h3>üèóÔ∏è Long-term Strategy (Next 90 Days)</h3>
                    <ul>
                        <li><strong>DevSecOps Integration:</strong> Implement shift-left security practices</li>
                        <li><strong>Automation:</strong> Deploy automated vulnerability management tools</li>
                        <li><strong>Training:</strong> Conduct security awareness training for development teams</li>
                        <li><strong>Compliance:</strong> Align with industry standards and frameworks</li>
                    </ul>
                </div>
            </div>

            <div class="section">
                <h2>üìã Report Methodology & Data Sources</h2>
                <table>
                    <tr><td><strong>Data Source</strong></td><td>WIZ Security Platform</td></tr>
                    <tr><td><strong>Analysis Period</strong></td><td>Current snapshot as of {datetime.now().strftime('%Y-%m-%d')}</td></tr>
                    <tr><td><strong>Total Vulnerabilities Analyzed</strong></td><td>{summary['total_vulnerabilities']:,}</td></tr>
                    <tr><td><strong>Risk Scoring Method</strong></td><td>CVSS v3.1 + Environmental factors</td></tr>
                    <tr><td><strong>Coverage Areas</strong></td><td>Cloud Infrastructure, Container Security, Application Security</td></tr>
                    <tr><td><strong>Report Generated By</strong></td><td>Phoenix Security Configuration System</td></tr>
                </table>
            </div>
        </div>
    </div>
</body>
</html>
"""
        
        return html_content

def main():
    """Main function to generate the executive report"""
    
    print("=" * 80)
    print("üõ°Ô∏è  Vulnerability Executive Report Generator")
    print("   Phoenix Security Configuration System")
    print("=" * 80)
    print()
    
    # Initialize analyzer
    csv_path = "/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/large_vulnerabilities.csv"
    
    try:
        print("üìä Loading vulnerability data...")
        analyzer = VulnerabilityAnalyzer(csv_path)
        
        print("üìä Analyzing vulnerability patterns...")
        summary = analyzer.generate_executive_summary()
        top_vulns = analyzer.get_top_vulnerabilities()
        ransomware = analyzer.analyze_ransomware_threats()
        
        print("üìÑ Generating comprehensive HTML executive report...")
        html_report = analyzer.generate_html_report()
        
        # Save HTML report
        report_path = "/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/vulnerability_executive_report.html"
        with open(report_path, 'w', encoding='utf-8') as f:
            f.write(html_report)
        
        print(f"‚úÖ Executive report generated successfully!")
        print(f"üìÑ Report saved to: {report_path}")
        
        # Print summary statistics
        print(f"\nüìã Key Findings Summary:")
        print(f"   ‚Ä¢ Total Vulnerabilities: {summary['total_vulnerabilities']:,}")
        print(f"   ‚Ä¢ Critical Vulnerabilities: {summary['critical_vulnerabilities']}")
        print(f"   ‚Ä¢ High Risk Vulnerabilities: {summary['high_vulnerabilities']}")
        print(f"   ‚Ä¢ Average Risk Score: {summary['average_risk_score']}")
        print(f"   ‚Ä¢ Assets Affected: {summary['total_assets_affected']:,}")
        print(f"   ‚Ä¢ Total Findings: {summary['total_findings']:,}")
        print(f"   ‚Ä¢ Remediation Rate: {summary['remediation_rate']}%")
        
        # Print top risks
        print(f"\nüö® Top 5 Highest Risk Vulnerabilities:")
        for i, (_, vuln) in enumerate(top_vulns['top_risk'].head(5).iterrows(), 1):
            print(f"   {i}. {vuln['name']} (Risk: {vuln['stats_risk']:.0f}, Assets: {vuln['stats_assetsCount']:.0f})")
        
        # Print ransomware threats
        known_ransomware = ransomware['known_ransomware']
        if not known_ransomware.empty:
            print(f"\nüîí Known Ransomware Threats Detected: {len(known_ransomware)}")
            for _, vuln in known_ransomware.head(3).iterrows():
                print(f"   ‚Ä¢ {vuln['name']} (Risk: {vuln['stats_risk']:.0f})")
        
        print(f"\nüéØ Open the HTML report in your browser for detailed analysis and visualizations!")
        
    except FileNotFoundError:
        print(f"‚ùå Error: CSV file not found at {csv_path}")
        print("Please ensure the vulnerability data has been converted to CSV format first.")
    except Exception as e:
        print(f"‚ùå Error generating report: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
