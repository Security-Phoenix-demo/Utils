#!/usr/bin/env python3
"""
PDF Vulnerability Executive Report Generator

This script creates a professional PDF version of the vulnerability executive report
using the Phoenix Security branding and logos.

Author: Phoenix Security Configuration System
Version: 1.0
Date: 2025
"""

import pandas as pd
from reportlab.lib.pagesizes import A4, letter
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.lib.colors import Color, HexColor, black, white, red, orange, blue, green
from reportlab.lib.units import inch, cm
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle, PageBreak, Image, KeepTogether
from reportlab.platypus.flowables import HRFlowable
from reportlab.lib.enums import TA_CENTER, TA_LEFT, TA_RIGHT, TA_JUSTIFY
from reportlab.pdfgen import canvas
from reportlab.lib import colors
from datetime import datetime
import os
from collections import defaultdict

class VulnerabilityPDFGenerator:
    def __init__(self, csv_file_path):
        """Initialize the PDF generator with vulnerability data"""
        self.df = pd.read_csv(csv_file_path)
        self.setup_data()
        self.setup_styles()
        
    def setup_data(self):
        """Clean and prepare data for analysis"""
        # Convert numeric columns
        numeric_cols = ['stats_risk', 'stats_riskMagnitude', 'stats_findingsCount', 
                       'stats_assetsCount', 'stats_findingStats_open', 'stats_findingStats_closed',
                       'stats_findingStats_critical', 'stats_findingStats_high', 
                       'stats_findingStats_medium', 'stats_findingStats_low']
        
        for col in numeric_cols:
            if col in self.df.columns:
                self.df[col] = pd.to_numeric(self.df[col], errors='coerce').fillna(0)
        
        # Extract CVE year from name
        self.df['cve_year'] = self.df['name'].str.extract(r'CVE-(\d{4})').astype(float)
        
    def setup_styles(self):
        """Setup custom styles for the PDF"""
        self.styles = getSampleStyleSheet()
        
        # Phoenix Security brand colors
        self.phoenix_orange = HexColor('#FF6B35')
        self.phoenix_dark = HexColor('#2C3E50')
        self.phoenix_blue = HexColor('#3498DB')
        self.phoenix_purple = HexColor('#9B59B6')
        
        # Custom styles
        self.styles.add(ParagraphStyle(
            name='PhoenixTitle',
            parent=self.styles['Title'],
            fontSize=24,
            spaceAfter=30,
            textColor=self.phoenix_dark,
            alignment=TA_CENTER,
            fontName='Helvetica-Bold'
        ))
        
        self.styles.add(ParagraphStyle(
            name='PhoenixHeading1',
            parent=self.styles['Heading1'],
            fontSize=16,
            spaceAfter=12,
            spaceBefore=20,
            textColor=self.phoenix_dark,
            fontName='Helvetica-Bold'
        ))
        
        self.styles.add(ParagraphStyle(
            name='PhoenixHeading2',
            parent=self.styles['Heading2'],
            fontSize=14,
            spaceAfter=10,
            spaceBefore=15,
            textColor=self.phoenix_purple,
            fontName='Helvetica-Bold'
        ))
        
        self.styles.add(ParagraphStyle(
            name='MetricValue',
            parent=self.styles['Normal'],
            fontSize=20,
            spaceAfter=5,
            textColor=self.phoenix_orange,
            fontName='Helvetica-Bold',
            alignment=TA_CENTER
        ))
        
        self.styles.add(ParagraphStyle(
            name='MetricLabel',
            parent=self.styles['Normal'],
            fontSize=10,
            textColor=self.phoenix_dark,
            alignment=TA_CENTER
        ))
        
        self.styles.add(ParagraphStyle(
            name='AlertText',
            parent=self.styles['Normal'],
            fontSize=11,
            textColor=red,
            fontName='Helvetica-Bold',
            spaceAfter=10
        ))
        
        self.styles.add(ParagraphStyle(
            name='PhoenixBodyText',
            parent=self.styles['Normal'],
            fontSize=10,
            spaceAfter=8,
            textColor=self.phoenix_dark,
            alignment=TA_JUSTIFY
        ))

    def generate_executive_summary(self):
        """Generate executive summary statistics"""
        total_vulns = len(self.df)
        total_assets_affected = self.df['stats_assetsCount'].sum()
        total_findings = self.df['stats_findingsCount'].sum()
        avg_risk_score = self.df['stats_risk'].mean()
        
        critical_vulns = (self.df['stats_findingStats_critical'] > 0).sum()
        high_vulns = (self.df['stats_findingStats_high'] > 0).sum()
        
        open_findings = self.df['stats_findingStats_open'].sum()
        closed_findings = self.df['stats_findingStats_closed'].sum()
        
        summary = {
            'total_vulnerabilities': total_vulns,
            'total_assets_affected': int(total_assets_affected),
            'total_findings': int(total_findings),
            'average_risk_score': round(avg_risk_score, 1),
            'critical_vulnerabilities': critical_vulns,
            'high_vulnerabilities': high_vulns,
            'open_findings': int(open_findings),
            'closed_findings': int(closed_findings),
            'remediation_rate': round((closed_findings / (open_findings + closed_findings)) * 100, 1) if (open_findings + closed_findings) > 0 else 0
        }
        
        return summary

    def get_top_vulnerabilities(self, top_n=10):
        """Get top vulnerabilities by various criteria"""
        top_risk = self.df.nlargest(top_n, 'stats_risk')[['name', 'stats_risk', 'stats_findingsCount', 'stats_assetsCount']]
        return top_risk

    def analyze_ransomware_threats(self):
        """Identify potential ransomware-related vulnerabilities"""
        ransomware_indicators = [
            'CVE-2021-44228', 'CVE-2021-45046', 'CVE-2017-11882', 'CVE-2020-1147',
            'CVE-2021-4034', 'CVE-2022-0847', 'CVE-2023-4911', 'CVE-2023-4863',
            'CVE-2022-37434', 'CVE-2007-4559'
        ]
        
        ransomware_vulns = self.df[self.df['name'].isin(ransomware_indicators)]
        high_risk_vulns = self.df[
            (self.df['stats_risk'] >= 900) & 
            (self.df['stats_findingStats_critical'] > 0)
        ].nlargest(10, 'stats_risk')
        
        return {
            'known_ransomware': ransomware_vulns,
            'high_risk_exploitable': high_risk_vulns
        }

    def analyze_application_trends(self):
        """Analyze trends in application vulnerabilities"""
        finding_types_data = []
        for _, row in self.df.iterrows():
            types = str(row['stats_findingTypes']).split(';') if pd.notna(row['stats_findingTypes']) else ['Unknown']
            for ftype in types:
                finding_types_data.append({
                    'type': ftype.strip(),
                    'risk': row['stats_risk'],
                    'findings': row['stats_findingsCount'],
                    'assets': row['stats_assetsCount'],
                    'critical': row['stats_findingStats_critical']
                })
        
        app_summary = defaultdict(lambda: {'risk_total': 0, 'findings': 0, 'assets': 0, 'critical': 0, 'count': 0})
        
        for item in finding_types_data:
            app_type = item['type']
            app_summary[app_type]['risk_total'] += item['risk']
            app_summary[app_type]['findings'] += item['findings']
            app_summary[app_type]['assets'] += item['assets']
            app_summary[app_type]['critical'] += item['critical']
            app_summary[app_type]['count'] += 1
        
        app_trends = {}
        for app_type, data in app_summary.items():
            app_trends[app_type] = {
                'average_risk': round(data['risk_total'] / data['count'], 1),
                'total_findings': data['findings'],
                'total_assets': data['assets'],
                'critical_count': data['critical']
            }
        
        return app_trends

    def generate_visualizations(self):
        """Generate visualization charts for the PDF with proper sizing"""
        import matplotlib.pyplot as plt
        import seaborn as sns
        
        # Set style for better looking plots
        plt.style.use('default')
        sns.set_palette("husl")
        
        chart_paths = []
        
        # 1. Risk Score Distribution
        fig1, ax1 = plt.subplots(figsize=(10, 6))  # Better aspect ratio
        self.df['stats_risk'].hist(bins=30, alpha=0.7, ax=ax1, color='#3498db')
        ax1.set_title('Vulnerability Risk Score Distribution', fontsize=16, fontweight='bold', pad=20)
        ax1.set_xlabel('Risk Score', fontsize=12)
        ax1.set_ylabel('Number of Vulnerabilities', fontsize=12)
        ax1.grid(True, alpha=0.3)
        plt.tight_layout(pad=2.0)
        risk_chart_path = '/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/pdf_risk_distribution.png'
        plt.savefig(risk_chart_path, dpi=300, bbox_inches='tight', facecolor='white')
        plt.close()
        chart_paths.append(risk_chart_path)
        
        # 2. Severity Distribution Pie Chart
        severity_data = {
            'Critical': int(self.df['stats_findingStats_critical'].sum()),
            'High': int(self.df['stats_findingStats_high'].sum()),
            'Medium': int(self.df['stats_findingStats_medium'].sum()),
            'Low': int(self.df['stats_findingStats_low'].sum())
        }
        
        fig2, ax2 = plt.subplots(figsize=(8, 8))  # Square for pie chart
        colors_pie = ['#e74c3c', '#f39c12', '#3498db', '#27ae60']
        wedges, texts, autotexts = ax2.pie(severity_data.values(), labels=severity_data.keys(), 
                                          autopct='%1.1f%%', startangle=90, colors=colors_pie,
                                          textprops={'fontsize': 12})
        ax2.set_title('Vulnerability Severity Distribution', fontsize=16, fontweight='bold', pad=20)
        for autotext in autotexts:
            autotext.set_color('white')
            autotext.set_fontweight('bold')
            autotext.set_fontsize(12)
        plt.tight_layout(pad=2.0)
        severity_chart_path = '/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/pdf_severity_distribution.png'
        plt.savefig(severity_chart_path, dpi=300, bbox_inches='tight', facecolor='white')
        plt.close()
        chart_paths.append(severity_chart_path)
        
        # 3. Top 10 Vulnerabilities by Risk
        top_vulns = self.df.nlargest(10, 'stats_risk')
        fig3, ax3 = plt.subplots(figsize=(12, 8))  # Wider for horizontal bars
        bars = ax3.barh(range(len(top_vulns)), top_vulns['stats_risk'], color='#e74c3c', alpha=0.8)
        ax3.set_yticks(range(len(top_vulns)))
        ax3.set_yticklabels(top_vulns['name'], fontsize=10)
        ax3.set_xlabel('Risk Score', fontsize=12)
        ax3.set_title('Top 10 Vulnerabilities by Risk Score', fontsize=16, fontweight='bold', pad=20)
        ax3.grid(True, alpha=0.3, axis='x')
        
        # Add value labels on bars
        for i, bar in enumerate(bars):
            width = bar.get_width()
            ax3.text(width + 10, bar.get_y() + bar.get_height()/2, 
                    f'{width:.0f}', ha='left', va='center', fontweight='bold', fontsize=10)
        
        plt.tight_layout(pad=2.0)
        top_vulns_chart_path = '/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/pdf_top_vulnerabilities.png'
        plt.savefig(top_vulns_chart_path, dpi=300, bbox_inches='tight', facecolor='white')
        plt.close()
        chart_paths.append(top_vulns_chart_path)
        
        # 4. CVE Year Trends (if we have year data)
        if 'cve_year' in self.df.columns:
            year_trends = self.df.groupby('cve_year')['stats_risk'].mean()
            if not year_trends.empty and len(year_trends) > 1:
                fig4, ax4 = plt.subplots(figsize=(12, 6))  # Wide for timeline
                ax4.plot(year_trends.index, year_trends.values, marker='o', linewidth=3, 
                        markersize=8, color='#9b59b6')
                ax4.set_title('Average Risk Score by CVE Year', fontsize=16, fontweight='bold', pad=20)
                ax4.set_xlabel('CVE Year', fontsize=12)
                ax4.set_ylabel('Average Risk Score', fontsize=12)
                ax4.grid(True, alpha=0.3)
                ax4.tick_params(axis='x', rotation=45, labelsize=10)
                ax4.tick_params(axis='y', labelsize=10)
                plt.tight_layout(pad=2.0)
                year_trends_chart_path = '/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/pdf_year_trends.png'
                plt.savefig(year_trends_chart_path, dpi=300, bbox_inches='tight', facecolor='white')
                plt.close()
                chart_paths.append(year_trends_chart_path)
        
        # 5. Application Types Distribution
        app_trends = self.analyze_application_trends()
        if app_trends:
            finding_counts = [data['total_findings'] for data in app_trends.values()]
            app_types = list(app_trends.keys())
            
            if len(app_types) > 1:
                fig5, ax5 = plt.subplots(figsize=(10, 6))  # Good aspect ratio for bars
                bars = ax5.bar(app_types, finding_counts, color=['#3498db', '#e67e22'], alpha=0.8)
                ax5.set_title('Findings by Application Type', fontsize=16, fontweight='bold', pad=20)
                ax5.set_xlabel('Application Type', fontsize=12)
                ax5.set_ylabel('Total Findings', fontsize=12)
                ax5.grid(True, alpha=0.3, axis='y')
                ax5.tick_params(axis='both', labelsize=10)
                
                # Add value labels on bars
                for bar in bars:
                    height = bar.get_height()
                    ax5.text(bar.get_x() + bar.get_width()/2., height + height*0.01,
                            f'{int(height):,}', ha='center', va='bottom', fontweight='bold', fontsize=10)
                
                plt.tight_layout(pad=2.0)
                app_chart_path = '/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/pdf_application_trends.png'
                plt.savefig(app_chart_path, dpi=300, bbox_inches='tight', facecolor='white')
                plt.close()
                chart_paths.append(app_chart_path)
        
        return chart_paths

    def create_header_footer(self, canvas, doc):
        """Create header and footer for each page"""
        canvas.saveState()
        
        # Header
        try:
            # Try to use the color logo on white background with proper aspect ratio
            logo_path = "/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/logos/Stacker Phoenix Security  copy 2.png"
            if os.path.exists(logo_path):
                try:
                    from PIL import Image as PILImage
                    with PILImage.open(logo_path) as img:
                        original_width, original_height = img.size
                        aspect_ratio = original_width / original_height
                        
                        # Set maximum width for header and calculate height
                        max_width = 120
                        calculated_height = max_width / aspect_ratio
                        
                        # If calculated height is too large, limit height and recalculate width
                        if calculated_height > 50:
                            max_height = 50
                            calculated_width = max_height * aspect_ratio
                            canvas.drawImage(logo_path, 50, A4[1] - 80, width=calculated_width, height=max_height)
                        else:
                            canvas.drawImage(logo_path, 50, A4[1] - 80, width=max_width, height=calculated_height)
                except:
                    # Fallback to preserveAspectRatio parameter
                    canvas.drawImage(logo_path, 50, A4[1] - 80, width=120, height=50, preserveAspectRatio=True, mask='auto')
        except:
            # Fallback to text header
            canvas.setFont("Helvetica-Bold", 12)
            canvas.setFillColor(self.phoenix_dark)
            canvas.drawString(50, A4[1] - 50, "PHOENIX SECURITY")
        
        # Header line
        canvas.setStrokeColor(self.phoenix_orange)
        canvas.setLineWidth(2)
        canvas.line(50, A4[1] - 90, A4[0] - 50, A4[1] - 90)
        
        # Footer
        canvas.setFont("Helvetica", 8)
        canvas.setFillColor(colors.grey)
        canvas.drawString(50, 30, f"Generated on {datetime.now().strftime('%B %d, %Y')}")
        canvas.drawRightString(A4[0] - 50, 30, f"Page {doc.page}")
        
        # Footer line
        canvas.setStrokeColor(self.phoenix_orange)
        canvas.setLineWidth(1)
        canvas.line(50, 45, A4[0] - 50, 45)
        
        canvas.restoreState()

    def create_metrics_table(self, summary):
        """Create a metrics summary table"""
        data = [
            ['Total Vulnerabilities', f"{summary['total_vulnerabilities']:,}"],
            ['Critical Vulnerabilities', f"{summary['critical_vulnerabilities']}"],
            ['High Risk Vulnerabilities', f"{summary['high_vulnerabilities']}"],
            ['Assets Affected', f"{summary['total_assets_affected']:,}"],
            ['Total Findings', f"{summary['total_findings']:,}"],
            ['Average Risk Score', f"{summary['average_risk_score']}"],
            ['Remediation Rate', f"{summary['remediation_rate']}%"]
        ]
        
        table = Table(data, colWidths=[3*inch, 1.5*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), self.phoenix_dark),
            ('TEXTCOLOR', (0, 0), (-1, 0), white),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 1), (-1, -1), 10),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
        ]))
        
        return table

    def create_vulnerability_table(self, vulns, title="Top Vulnerabilities"):
        """Create a table for vulnerability data"""
        data = [['CVE ID', 'Risk Score', 'Findings', 'Assets']]
        
        for _, vuln in vulns.iterrows():
            risk_score = f"{vuln['stats_risk']:.0f}"
            findings = f"{vuln['stats_findingsCount']:.0f}"
            assets = f"{vuln['stats_assetsCount']:.0f}"
            data.append([vuln['name'], risk_score, findings, assets])
        
        table = Table(data, colWidths=[2.5*inch, 1*inch, 1*inch, 1*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), self.phoenix_dark),
            ('TEXTCOLOR', (0, 0), (-1, 0), white),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 10),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 1), (-1, -1), 9),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
        ]))
        
        return table

    def create_app_trends_table(self, app_trends):
        """Create application trends table"""
        data = [['Application Type', 'Avg Risk', 'Findings', 'Assets', 'Critical']]
        
        sorted_apps = sorted(app_trends.items(), key=lambda x: x[1]['average_risk'], reverse=True)
        
        for app_type, data_row in sorted_apps:
            data.append([
                app_type,
                f"{data_row['average_risk']:.1f}",
                f"{data_row['total_findings']}",
                f"{data_row['total_assets']}",
                f"{data_row['critical_count']}"
            ])
        
        table = Table(data, colWidths=[2*inch, 1*inch, 1*inch, 1*inch, 1*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), self.phoenix_purple),
            ('TEXTCOLOR', (0, 0), (-1, 0), white),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 10),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 1), (-1, -1), 9),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
        ]))
        
        return table

    def generate_pdf_report(self, output_path, chart_paths=None):
        """Generate the complete PDF report with properly sized visualizations"""
        doc = SimpleDocTemplate(
            output_path,
            pagesize=A4,
            rightMargin=50,
            leftMargin=50,
            topMargin=100,
            bottomMargin=60
        )
        
        # Build the story
        story = []
        
        # Title page
        story.append(Spacer(1, 2*inch))
        
        # Try to add logo with proper aspect ratio
        try:
            logo_path = "/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/logos/Stacker Phoenix Security  copy 2.png"
            if os.path.exists(logo_path):
                # Get the original image dimensions to calculate proper aspect ratio
                from PIL import Image as PILImage
                try:
                    with PILImage.open(logo_path) as img:
                        original_width, original_height = img.size
                        aspect_ratio = original_width / original_height
                        
                        # Set maximum width and calculate height to preserve aspect ratio
                        max_width = 3*inch
                        calculated_height = max_width / aspect_ratio
                        
                        # If calculated height is too large, limit height and recalculate width
                        if calculated_height > 2*inch:
                            max_height = 2*inch
                            calculated_width = max_height * aspect_ratio
                            logo = Image(logo_path, width=calculated_width, height=max_height)
                        else:
                            logo = Image(logo_path, width=max_width, height=calculated_height)
                        
                        logo.hAlign = 'CENTER'
                        story.append(logo)
                        story.append(Spacer(1, 0.5*inch))
                except:
                    # Fallback: use reportlab's preserveAspectRatio (less precise)
                    logo = Image(logo_path, width=3*inch, height=2*inch)
                    logo.hAlign = 'CENTER'
                    story.append(logo)
                    story.append(Spacer(1, 0.5*inch))
        except:
            pass
        
        story.append(Paragraph("VULNERABILITY EXECUTIVE REPORT", self.styles['PhoenixTitle']))
        story.append(Spacer(1, 0.3*inch))
        story.append(Paragraph("Comprehensive Security Assessment", self.styles['Heading2']))
        story.append(Spacer(1, 0.5*inch))
        story.append(Paragraph(f"Generated on {datetime.now().strftime('%B %d, %Y')}", self.styles['Normal']))
        story.append(Spacer(1, 0.2*inch))
        story.append(Paragraph("Phoenix Security Configuration System", self.styles['Normal']))
        
        story.append(PageBreak())
        
        # Executive Summary
        summary = self.generate_executive_summary()
        
        story.append(Paragraph("EXECUTIVE SUMMARY", self.styles['PhoenixHeading1']))
        story.append(HRFlowable(width="100%", thickness=2, color=self.phoenix_orange))
        story.append(Spacer(1, 20))
        
        summary_text = f"""
        This comprehensive vulnerability assessment reveals critical security insights across your infrastructure. 
        Our analysis covers <b>{summary['total_vulnerabilities']:,} vulnerabilities</b> affecting 
        <b>{summary['total_assets_affected']:,} assets</b> with a total of 
        <b>{summary['total_findings']:,} findings</b>.
        
        <b>Current Security Posture:</b> The analysis indicates a HIGH RISK environment with 
        {summary['critical_vulnerabilities']} critical vulnerabilities requiring immediate attention and 
        {summary['high_vulnerabilities']} high-risk vulnerabilities needing urgent remediation.
        """
        
        story.append(Paragraph(summary_text, self.styles['PhoenixBodyText']))
        story.append(Spacer(1, 20))
        
        # Key Metrics Table
        story.append(Paragraph("Key Metrics", self.styles['PhoenixHeading2']))
        story.append(self.create_metrics_table(summary))
        story.append(Spacer(1, 30))
        
        # Critical Alert Box
        story.append(Paragraph("‚ö†Ô∏è CRITICAL SECURITY ALERT", self.styles['AlertText']))
        alert_text = f"""
        <b>IMMEDIATE ACTION REQUIRED:</b> Your environment contains {summary['critical_vulnerabilities']} 
        critical vulnerabilities with a 0% remediation rate. The presence of known ransomware-related 
        CVEs poses significant risk to organizational security and business continuity.
        """
        story.append(Paragraph(alert_text, self.styles['PhoenixBodyText']))
        
        story.append(PageBreak())
        
        # Add Visualizations Section with proper sizing
        if chart_paths:
            story.append(Paragraph("VULNERABILITY ANALYTICS & VISUALIZATIONS", self.styles['PhoenixHeading1']))
            story.append(HRFlowable(width="100%", thickness=2, color=self.phoenix_blue))
            story.append(Spacer(1, 20))
            
            viz_text = """
            The following visualizations provide comprehensive insights into the vulnerability 
            landscape, risk distribution, and trend analysis across your infrastructure.
            """
            story.append(Paragraph(viz_text, self.styles['PhoenixBodyText']))
            story.append(Spacer(1, 20))
            
            # Add each chart with proper sizing to prevent squishing
            for i, chart_path in enumerate(chart_paths):
                if os.path.exists(chart_path):
                    try:
                        # Add chart title based on filename
                        chart_name = os.path.basename(chart_path).replace('pdf_', '').replace('.png', '').replace('_', ' ').title()
                        story.append(Paragraph(f"{i+1}. {chart_name}", self.styles['PhoenixHeading2']))
                        
                        # Calculate proper image size based on chart type to prevent squishing
                        if 'severity_distribution' in chart_path:
                            # Square aspect ratio for pie charts
                            chart_img = Image(chart_path, width=5*inch, height=5*inch)
                        elif 'top_vulnerabilities' in chart_path:
                            # Wide aspect ratio for horizontal bar charts
                            chart_img = Image(chart_path, width=7*inch, height=4.5*inch)
                        elif 'year_trends' in chart_path:
                            # Wide aspect ratio for timeline charts
                            chart_img = Image(chart_path, width=7*inch, height=3.5*inch)
                        elif 'application_trends' in chart_path:
                            # Standard aspect ratio for bar charts
                            chart_img = Image(chart_path, width=6*inch, height=3.5*inch)
                        else:
                            # Default sizing for other charts
                            chart_img = Image(chart_path, width=6*inch, height=3.5*inch)
                        
                        chart_img.hAlign = 'CENTER'
                        story.append(chart_img)
                        story.append(Spacer(1, 25))
                        
                        # Add page break after every 2 charts to avoid overcrowding
                        if (i + 1) % 2 == 0 and i < len(chart_paths) - 1:
                            story.append(PageBreak())
                    except Exception as e:
                        print(f"Warning: Could not add chart {chart_path}: {e}")
            
            story.append(PageBreak())
        
        # Top Critical Vulnerabilities
        story.append(Paragraph("TOP CRITICAL VULNERABILITIES", self.styles['PhoenixHeading1']))
        story.append(HRFlowable(width="100%", thickness=2, color=self.phoenix_orange))
        story.append(Spacer(1, 20))
        
        top_vulns = self.get_top_vulnerabilities(15)
        story.append(Paragraph("Highest Risk Vulnerabilities Requiring Immediate Attention", self.styles['PhoenixHeading2']))
        story.append(self.create_vulnerability_table(top_vulns.head(10)))
        story.append(Spacer(1, 30))
        
        # Ransomware Threats
        story.append(Paragraph("RANSOMWARE & HIGH-IMPACT THREATS", self.styles['PhoenixHeading1']))
        story.append(HRFlowable(width="100%", thickness=2, color=red))
        story.append(Spacer(1, 20))
        
        ransomware = self.analyze_ransomware_threats()
        
        ransomware_text = """
        <b>üéØ CRITICAL SECURITY ALERT:</b> The following vulnerabilities are commonly exploited in 
        ransomware attacks and advanced persistent threats (APTs). These represent the highest 
        priority for immediate remediation.
        """
        story.append(Paragraph(ransomware_text, self.styles['AlertText']))
        story.append(Spacer(1, 15))
        
        if not ransomware['known_ransomware'].empty:
            story.append(Paragraph("Known Ransomware-Related CVEs Detected:", self.styles['PhoenixHeading2']))
            story.append(self.create_vulnerability_table(ransomware['known_ransomware'], "Ransomware CVEs"))
            story.append(Spacer(1, 20))
        
        story.append(Paragraph("High-Risk Exploitable Vulnerabilities:", self.styles['PhoenixHeading2']))
        story.append(self.create_vulnerability_table(ransomware['high_risk_exploitable'].head(10), "High-Risk CVEs"))
        
        story.append(PageBreak())
        
        # Application Trends
        story.append(Paragraph("APPLICATION & INFRASTRUCTURE TRENDS", self.styles['PhoenixHeading1']))
        story.append(HRFlowable(width="100%", thickness=2, color=self.phoenix_blue))
        story.append(Spacer(1, 20))
        
        app_trends = self.analyze_application_trends()
        
        trends_text = """
        Analysis of vulnerability distribution across different application types and infrastructure 
        components reveals key areas of security concern and resource allocation priorities.
        """
        story.append(Paragraph(trends_text, self.styles['PhoenixBodyText']))
        story.append(Spacer(1, 15))
        
        story.append(self.create_app_trends_table(app_trends))
        story.append(Spacer(1, 30))
        
        # Strategic Recommendations
        story.append(Paragraph("STRATEGIC RECOMMENDATIONS", self.styles['PhoenixHeading1']))
        story.append(HRFlowable(width="100%", thickness=2, color=self.phoenix_purple))
        story.append(Spacer(1, 20))
        
        # Immediate Actions
        story.append(Paragraph("üö® Immediate Actions (Next 7 Days)", self.styles['PhoenixHeading2']))
        immediate_actions = """
        <b>Critical Priority:</b>
        ‚Ä¢ Address CVE-2021-44228 (Log4j) immediately - CRITICAL RANSOMWARE THREAT
        ‚Ä¢ Patch all vulnerabilities with risk scores ‚â• 900
        ‚Ä¢ Isolate assets with multiple critical vulnerabilities
        ‚Ä¢ Implement 24/7 monitoring for ransomware indicators
        ‚Ä¢ Activate incident response team for critical vulnerabilities
        """
        story.append(Paragraph(immediate_actions, self.styles['PhoenixBodyText']))
        story.append(Spacer(1, 15))
        
        # Short-term Actions
        story.append(Paragraph("üìã Short-term Actions (Next 30 Days)", self.styles['PhoenixHeading2']))
        short_term = """
        <b>Operational Priorities:</b>
        ‚Ä¢ Develop comprehensive remediation timeline for all high-severity vulnerabilities
        ‚Ä¢ Strengthen security controls in CLOUD and CONTAINER environments
        ‚Ä¢ Increase vulnerability scanning frequency for critical assets
        ‚Ä¢ Update incident response procedures for identified threat vectors
        ‚Ä¢ Implement automated patch management where possible
        """
        story.append(Paragraph(short_term, self.styles['PhoenixBodyText']))
        story.append(Spacer(1, 15))
        
        # Long-term Strategy
        story.append(Paragraph("üèóÔ∏è Long-term Strategy (Next 90 Days)", self.styles['PhoenixHeading2']))
        long_term = """
        <b>Strategic Initiatives:</b>
        ‚Ä¢ Implement DevSecOps practices and shift-left security
        ‚Ä¢ Deploy automated vulnerability management and orchestration tools
        ‚Ä¢ Conduct organization-wide security awareness training
        ‚Ä¢ Align security practices with industry frameworks and compliance standards
        ‚Ä¢ Establish continuous security monitoring and threat intelligence programs
        """
        story.append(Paragraph(long_term, self.styles['PhoenixBodyText']))
        
        story.append(PageBreak())
        
        # Methodology and Data Sources
        story.append(Paragraph("REPORT METHODOLOGY & DATA SOURCES", self.styles['PhoenixHeading1']))
        story.append(HRFlowable(width="100%", thickness=2, color=self.phoenix_dark))
        story.append(Spacer(1, 20))
        
        methodology_data = [
            ['Data Source', 'WIZ Security Platform'],
            ['Analysis Period', f"Current snapshot as of {datetime.now().strftime('%Y-%m-%d')}"],
            ['Total Vulnerabilities Analyzed', f"{summary['total_vulnerabilities']:,}"],
            ['Risk Scoring Method', 'CVSS v3.1 + Environmental factors'],
            ['Coverage Areas', 'Cloud Infrastructure, Container Security, Application Security'],
            ['Report Generated By', 'Phoenix Security Configuration System']
        ]
        
        methodology_table = Table(methodology_data, colWidths=[2.5*inch, 3*inch])
        methodology_table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), self.phoenix_dark),
            ('TEXTCOLOR', (0, 0), (-1, 0), white),
            ('ALIGN', (0, 0), (-1, -1), 'LEFT'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 1), (-1, -1), 10),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey])
        ]))
        
        story.append(methodology_table)
        story.append(Spacer(1, 30))
        
        # Conclusion
        story.append(Paragraph("CONCLUSION", self.styles['PhoenixHeading2']))
        conclusion_text = f"""
        This vulnerability assessment reveals a <b>HIGH RISK</b> security environment requiring immediate 
        executive attention and resource allocation. With {summary['critical_vulnerabilities']} critical 
        vulnerabilities and a 0% remediation rate, the organization faces significant exposure to 
        ransomware attacks and advanced persistent threats.
        
        <b>Key Priorities:</b>
        1. Emergency response to Log4j vulnerabilities (CVE-2021-44228)
        2. Comprehensive remediation program for {summary['high_vulnerabilities']} high-risk vulnerabilities
        3. Enhanced monitoring and incident response capabilities
        4. Long-term security program maturation
        
        Regular monitoring and assessment are recommended to track remediation progress and identify 
        emerging threats in this dynamic security landscape.
        """
        story.append(Paragraph(conclusion_text, self.styles['PhoenixBodyText']))
        
        # Build PDF with custom page template
        doc.build(story, onFirstPage=self.create_header_footer, onLaterPages=self.create_header_footer)
        
        # Clean up temporary chart files
        if chart_paths:
            for chart_path in chart_paths:
                try:
                    if os.path.exists(chart_path):
                        os.remove(chart_path)
                except Exception as e:
                    print(f"Note: Could not remove temporary chart file {chart_path}: {e}")
        
        return True

def main():
    """Main function to generate the PDF report"""
    
    print("=" * 80)
    print("üìÑ PDF Vulnerability Executive Report Generator")
    print("   Phoenix Security Configuration System")
    print("=" * 80)
    print()
    
    csv_path = "/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/large_vulnerabilities.csv"
    output_path = "/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/Phoenix_Security_Vulnerability_Executive_Report.pdf"
    
    try:
        print("üìä Loading vulnerability data...")
        generator = VulnerabilityPDFGenerator(csv_path)
        
        print("üìà Generating visualization charts with proper aspect ratios...")
        chart_paths = generator.generate_visualizations()
        
        print("üìÑ Generating professional PDF report...")
        success = generator.generate_pdf_report(output_path, chart_paths)
        
        if success:
            print(f"‚úÖ PDF report generated successfully!")
            print(f"üìÑ Report saved to: {output_path}")
            
            # Print summary
            summary = generator.generate_executive_summary()
            print(f"\nüìã Report Summary:")
            print(f"   ‚Ä¢ Total Vulnerabilities: {summary['total_vulnerabilities']:,}")
            print(f"   ‚Ä¢ Critical Vulnerabilities: {summary['critical_vulnerabilities']}")
            print(f"   ‚Ä¢ High Risk Vulnerabilities: {summary['high_vulnerabilities']}")
            print(f"   ‚Ä¢ Assets Affected: {summary['total_assets_affected']:,}")
            print(f"   ‚Ä¢ Average Risk Score: {summary['average_risk_score']}")
            
            print(f"\nüì± PDF Features:")
            print(f"   ‚Ä¢ Professional Phoenix Security branding")
            print(f"   ‚Ä¢ Executive summary with key metrics")
            print(f"   ‚Ä¢ Top critical vulnerabilities analysis")
            print(f"   ‚Ä¢ Ransomware threat assessment")
            print(f"   ‚Ä¢ Application trends and recommendations")
            print(f"   ‚Ä¢ Strategic action plans")
        else:
            print("‚ùå Failed to generate PDF report")
            
    except FileNotFoundError:
        print(f"‚ùå Error: CSV file not found at {csv_path}")
        print("Please ensure the vulnerability data has been converted to CSV format first.")
    except Exception as e:
        print(f"‚ùå Error generating PDF report: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
