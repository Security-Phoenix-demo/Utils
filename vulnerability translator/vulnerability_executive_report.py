#!/usr/bin/env python3
"""
Vulnerability Executive Report Generator

This script analyzes vulnerability data and generates comprehensive executive reports
with trend analysis, top threats, and security insights.

Author: Phoenix Security Configuration System
Version: 1.0
Date: 2025
"""

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import numpy as np
from datetime import datetime, timedelta
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8')
sns.set_palette("husl")

class VulnerabilityAnalyzer:
    def __init__(self, csv_file_path):
        """Initialize the analyzer with CSV data"""
        self.df = pd.read_csv(csv_file_path)
        self.setup_data()
        
    def setup_data(self):
        """Clean and prepare data for analysis"""
        # Convert numeric columns
        numeric_cols = ['stats_risk', 'stats_riskMagnitude', 'stats_findingsCount', 
                       'stats_assetsCount', 'stats_findingStats_open', 'stats_findingStats_closed',
                       'stats_findingStats_critical', 'stats_findingStats_high', 
                       'stats_findingStats_medium', 'stats_findingStats_low']
        
        for col in numeric_cols:
            if col in self.df.columns:
                self.df[col] = pd.to_numeric(self.df[col], errors='coerce').fillna(0)
        
        # Extract CVE year from name
        self.df['cve_year'] = self.df['name'].str.extract(r'CVE-(\d{4})').astype(float)
        
        # Calculate total severity
        self.df['total_severity_count'] = (self.df['stats_findingStats_critical'] + 
                                         self.df['stats_findingStats_high'] + 
                                         self.df['stats_findingStats_medium'] + 
                                         self.df['stats_findingStats_low'])
        
        # Create severity category
        self.df['primary_severity'] = self.df.apply(self._get_primary_severity, axis=1)
        
    def _get_primary_severity(self, row):
        """Determine primary severity level for each vulnerability"""
        if row['stats_findingStats_critical'] > 0:
            return 'Critical'
        elif row['stats_findingStats_high'] > 0:
            return 'High'
        elif row['stats_findingStats_medium'] > 0:
            return 'Medium'
        elif row['stats_findingStats_low'] > 0:
            return 'Low'
        else:
            return 'Unknown'
            
    def generate_executive_summary(self):
        """Generate executive summary statistics"""
        total_vulns = len(self.df)
        total_assets_affected = self.df['stats_assetsCount'].sum()
        total_findings = self.df['stats_findingsCount'].sum()
        avg_risk_score = self.df['stats_risk'].mean()
        
        critical_vulns = (self.df['stats_findingStats_critical'] > 0).sum()
        high_vulns = (self.df['stats_findingStats_high'] > 0).sum()
        
        open_findings = self.df['stats_findingStats_open'].sum()
        closed_findings = self.df['stats_findingStats_closed'].sum()
        
        summary = {
            'total_vulnerabilities': total_vulns,
            'total_assets_affected': int(total_assets_affected),
            'total_findings': int(total_findings),
            'average_risk_score': round(avg_risk_score, 1),
            'critical_vulnerabilities': critical_vulns,
            'high_vulnerabilities': high_vulns,
            'open_findings': int(open_findings),
            'closed_findings': int(closed_findings),
            'remediation_rate': round((closed_findings / (open_findings + closed_findings)) * 100, 1) if (open_findings + closed_findings) > 0 else 0
        }
        
        return summary
        
    def get_top_vulnerabilities(self, top_n=10):
        """Get top vulnerabilities by various criteria"""
        # Top by risk score
        top_risk = self.df.nlargest(top_n, 'stats_risk')[['name', 'stats_risk', 'stats_findingsCount', 'stats_assetsCount']]
        
        # Top by asset count
        top_assets = self.df.nlargest(top_n, 'stats_assetsCount')[['name', 'stats_assetsCount', 'stats_risk', 'stats_findingsCount']]
        
        # Top by findings count
        top_findings = self.df.nlargest(top_n, 'stats_findingsCount')[['name', 'stats_findingsCount', 'stats_assetsCount', 'stats_risk']]
        
        return {
            'top_risk': top_risk,
            'top_assets': top_assets,
            'top_findings': top_findings
        }
        
    def analyze_ransomware_threats(self):
        """Identify potential ransomware-related vulnerabilities"""
        # Common ransomware CVEs (based on known patterns)
        ransomware_indicators = [
            'CVE-2021-44228',  # Log4j
            'CVE-2021-45046',  # Log4j
            'CVE-2017-11882',  # Office
            'CVE-2020-1147',   # NET Framework
            'CVE-2021-4034',   # PwnKit
            'CVE-2022-0847',   # DirtyPipe
            'CVE-2023-4911',   # Looney Tunables
        ]
        
        ransomware_vulns = self.df[self.df['name'].isin(ransomware_indicators)]
        
        # Also look for high-risk vulnerabilities that could be exploited
        high_risk_vulns = self.df[
            (self.df['stats_risk'] >= 900) & 
            (self.df['stats_findingStats_critical'] > 0)
        ].nlargest(10, 'stats_risk')
        
        return {
            'known_ransomware': ransomware_vulns,
            'high_risk_exploitable': high_risk_vulns
        }
        
    def analyze_application_trends(self):
        """Analyze trends in application vulnerabilities"""
        # Group by finding types
        finding_types_data = []
        for _, row in self.df.iterrows():
            types = str(row['stats_findingTypes']).split(';') if pd.notna(row['stats_findingTypes']) else ['Unknown']
            for ftype in types:
                finding_types_data.append({
                    'type': ftype.strip(),
                    'risk': row['stats_risk'],
                    'findings': row['stats_findingsCount'],
                    'assets': row['stats_assetsCount']
                })
        
        types_df = pd.DataFrame(finding_types_data)
        app_trends = types_df.groupby('type').agg({
            'risk': 'mean',
            'findings': 'sum',
            'assets': 'sum'
        }).round(2)
        
        return app_trends
        
    def analyze_time_trends(self):
        """Analyze vulnerability trends over time"""
        # Group by CVE year
        year_trends = self.df.groupby('cve_year').agg({
            'stats_risk': 'mean',
            'stats_findingsCount': 'sum',
            'stats_assetsCount': 'sum',
            'stats_findingStats_critical': 'sum',
            'stats_findingStats_high': 'sum',
            'stats_findingStats_medium': 'sum',
            'stats_findingStats_low': 'sum'
        }).round(2)
        
        return year_trends
        
    def generate_severity_distribution(self):
        """Generate severity distribution analysis"""
        severity_data = {
            'Critical': self.df['stats_findingStats_critical'].sum(),
            'High': self.df['stats_findingStats_high'].sum(),
            'Medium': self.df['stats_findingStats_medium'].sum(),
            'Low': self.df['stats_findingStats_low'].sum()
        }
        
        return severity_data
        
    def create_visualizations(self):
        """Create comprehensive visualizations"""
        
        # 1. Risk Score Distribution
        fig1, ax1 = plt.subplots(figsize=(10, 6))
        self.df['stats_risk'].hist(bins=30, alpha=0.7, ax=ax1)
        ax1.set_title('Vulnerability Risk Score Distribution')
        ax1.set_xlabel('Risk Score')
        ax1.set_ylabel('Number of Vulnerabilities')
        plt.tight_layout()
        plt.savefig('/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/risk_distribution.png', dpi=300)
        plt.close()
        
        # 2. Severity Distribution Pie Chart
        severity_data = self.generate_severity_distribution()
        fig2, ax2 = plt.subplots(figsize=(8, 8))
        ax2.pie(severity_data.values(), labels=severity_data.keys(), autopct='%1.1f%%', startangle=90)
        ax2.set_title('Vulnerability Severity Distribution')
        plt.tight_layout()
        plt.savefig('/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/severity_distribution.png', dpi=300)
        plt.close()
        
        # 3. Top 10 Vulnerabilities by Risk
        top_vulns = self.df.nlargest(10, 'stats_risk')
        fig3, ax3 = plt.subplots(figsize=(12, 8))
        ax3.barh(range(len(top_vulns)), top_vulns['stats_risk'], color='red', alpha=0.7)
        ax3.set_yticks(range(len(top_vulns)))
        ax3.set_yticklabels(top_vulns['name'], fontsize=8)
        ax3.set_xlabel('Risk Score')
        ax3.set_title('Top 10 Vulnerabilities by Risk Score')
        plt.tight_layout()
        plt.savefig('/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/top_vulnerabilities.png', dpi=300)
        plt.close()
        
        # 4. CVE Year Trends
        year_trends = self.analyze_time_trends()
        if not year_trends.empty:
            fig4, ax4 = plt.subplots(figsize=(12, 6))
            ax4.plot(year_trends.index, year_trends['stats_risk'], marker='o', linewidth=2, markersize=6)
            ax4.set_title('Average Risk Score by CVE Year')
            ax4.set_xlabel('CVE Year')
            ax4.set_ylabel('Average Risk Score')
            ax4.grid(True, alpha=0.3)
            plt.tight_layout()
            plt.savefig('/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/year_trends.png', dpi=300)
            plt.close()
        
        # 5. Finding Types Distribution
        app_trends = self.analyze_application_trends()
        if not app_trends.empty:
            fig5, ax5 = plt.subplots(figsize=(10, 6))
            app_trends['findings'].plot(kind='bar', ax=ax5)
            ax5.set_title('Findings by Application Type')
            ax5.set_xlabel('Application Type')
            ax5.set_ylabel('Total Findings')
            plt.xticks(rotation=45)
            plt.tight_layout()
            plt.savefig('/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/application_trends.png', dpi=300)
            plt.close()
        
        print("‚úÖ All visualizations saved successfully!")
        
    def generate_html_report(self):
        """Generate comprehensive HTML executive report"""
        
        summary = self.generate_executive_summary()
        top_vulns = self.get_top_vulnerabilities()
        ransomware = self.analyze_ransomware_threats()
        app_trends = self.analyze_application_trends()
        time_trends = self.analyze_time_trends()
        
        html_content = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Vulnerability Executive Report</title>
    <style>
        body {{ font-family: Arial, sans-serif; margin: 40px; background-color: #f5f5f5; }}
        .container {{ max-width: 1200px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }}
        .header {{ text-align: center; border-bottom: 3px solid #e74c3c; padding-bottom: 20px; margin-bottom: 30px; position: relative; }}
        .logo-container {{ display: flex; justify-content: center; align-items: center; margin-bottom: 20px; }}
        .logo {{ max-width: 200px; max-height: 120px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3)); }}
        .phoenix-branding {{ display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 30px; }}
        .phoenix-text {{ font-size: 1.8em; font-weight: 600; letter-spacing: 2px; }}
        .phoenix-orange {{ color: #FF6B35; }}
        .footer-logo {{ max-width: 150px; max-height: 80px; opacity: 0.8; }}
        .section {{ margin-bottom: 30px; }}
        .metric-grid {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }}
        .metric-card {{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }}
        .metric-value {{ font-size: 2em; font-weight: bold; }}
        .metric-label {{ font-size: 0.9em; opacity: 0.9; }}
        .critical {{ background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }}
        .high {{ background: linear-gradient(135deg, #ffa726 0%, #ff7043 100%); }}
        .medium {{ background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%); }}
        .low {{ background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%); }}
        table {{ width: 100%; border-collapse: collapse; margin: 15px 0; }}
        th, td {{ padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }}
        th {{ background-color: #34495e; color: white; }}
        tr:nth-child(even) {{ background-color: #f2f2f2; }}
        .highlight {{ background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; }}
        .alert {{ background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; }}
        h1 {{ color: #2c3e50; }}
        h2 {{ color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; }}
        h3 {{ color: #7f8c8d; }}
        .timestamp {{ color: #7f8c8d; font-style: italic; }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="../logos/Stacked Black White CONTRAST Purple NOTEXT.jpg" alt="Phoenix Security Logo" class="logo">
            </div>
            <div class="phoenix-branding">
                <span class="phoenix-text">PHOENIX <span class="phoenix-orange">SECURITY</span></span>
            </div>
            <h1>üõ°Ô∏è Vulnerability Executive Report</h1>
            <p class="timestamp">Generated on {datetime.now().strftime('%Y-%m-%d at %H:%M:%S')}</p>
            <p>Comprehensive Security Assessment & Analysis</p>
        </div>

        <div class="section">
            <h2>üìä Executive Summary</h2>
            <div class="metric-grid">
                <div class="metric-card">
                    <div class="metric-value">{summary['total_vulnerabilities']:,}</div>
                    <div class="metric-label">Total Vulnerabilities</div>
                </div>
                <div class="metric-card critical">
                    <div class="metric-value">{summary['critical_vulnerabilities']}</div>
                    <div class="metric-label">Critical Vulnerabilities</div>
                </div>
                <div class="metric-card high">
                    <div class="metric-value">{summary['high_vulnerabilities']}</div>
                    <div class="metric-label">High Risk Vulnerabilities</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{summary['total_assets_affected']:,}</div>
                    <div class="metric-label">Assets Affected</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">{summary['average_risk_score']}</div>
                    <div class="metric-label">Average Risk Score</div>
                </div>
                <div class="metric-card medium">
                    <div class="metric-value">{summary['remediation_rate']}%</div>
                    <div class="metric-label">Remediation Rate</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üö® Top Exploited Vulnerabilities</h2>
            <table>
                <thead>
                    <tr>
                        <th>CVE ID</th>
                        <th>Risk Score</th>
                        <th>Findings Count</th>
                        <th>Assets Affected</th>
                    </tr>
                </thead>
                <tbody>
"""
        
        for _, vuln in top_vulns['top_risk'].head(10).iterrows():
            html_content += f"""
                    <tr>
                        <td>{vuln['name']}</td>
                        <td>{vuln['stats_risk']}</td>
                        <td>{vuln['stats_findingsCount']}</td>
                        <td>{vuln['stats_assetsCount']}</td>
                    </tr>
"""
        
        html_content += """
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>üîí Ransomware-Related Threats</h2>
            <div class="alert">
                <strong>‚ö†Ô∏è Critical Alert:</strong> The following vulnerabilities are commonly exploited in ransomware attacks and require immediate attention.
            </div>
            <table>
                <thead>
                    <tr>
                        <th>CVE ID</th>
                        <th>Risk Score</th>
                        <th>Critical Findings</th>
                        <th>Assets at Risk</th>
                    </tr>
                </thead>
                <tbody>
"""
        
        for _, vuln in ransomware['high_risk_exploitable'].head(10).iterrows():
            html_content += f"""
                    <tr>
                        <td>{vuln['name']}</td>
                        <td>{vuln['stats_risk']}</td>
                        <td>{vuln['stats_findingStats_critical']}</td>
                        <td>{vuln['stats_assetsCount']}</td>
                    </tr>
"""
        
        html_content += """
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>üì± Application Trends</h2>
            <table>
                <thead>
                    <tr>
                        <th>Application Type</th>
                        <th>Average Risk Score</th>
                        <th>Total Findings</th>
                        <th>Assets Affected</th>
                    </tr>
                </thead>
                <tbody>
"""
        
        for app_type, data in app_trends.iterrows():
            html_content += f"""
                    <tr>
                        <td>{app_type}</td>
                        <td>{data['risk']:.1f}</td>
                        <td>{int(data['findings'])}</td>
                        <td>{int(data['assets'])}</td>
                    </tr>
"""
        
        # Add time trends if available
        if not time_trends.empty:
            html_content += """
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>üìà Vulnerability Trends Over Time</h2>
            <table>
                <thead>
                    <tr>
                        <th>CVE Year</th>
                        <th>Average Risk</th>
                        <th>Total Findings</th>
                        <th>Critical Count</th>
                        <th>High Count</th>
                    </tr>
                </thead>
                <tbody>
"""
            
            for year, data in time_trends.tail(10).iterrows():
                html_content += f"""
                        <tr>
                            <td>{int(year) if not pd.isna(year) else 'Unknown'}</td>
                            <td>{data['stats_risk']:.1f}</td>
                            <td>{int(data['stats_findingsCount'])}</td>
                            <td>{int(data['stats_findingStats_critical'])}</td>
                            <td>{int(data['stats_findingStats_high'])}</td>
                        </tr>
"""
        
        html_content += """
                </tbody>
            </table>
        </div>

        <div class="section">
            <h2>üéØ Key Recommendations</h2>
            <div class="highlight">
                <h3>Immediate Actions Required:</h3>
                <ul>
                    <li><strong>Priority 1:</strong> Address all Critical severity vulnerabilities immediately</li>
                    <li><strong>Priority 2:</strong> Focus on vulnerabilities with risk scores above 900</li>
                    <li><strong>Priority 3:</strong> Implement monitoring for ransomware-related CVEs</li>
                    <li><strong>Priority 4:</strong> Develop remediation timeline for High severity vulnerabilities</li>
                </ul>
            </div>
            
            <div class="highlight">
                <h3>Strategic Initiatives:</h3>
                <ul>
                    <li>Enhance vulnerability management processes for CLOUD and CONTAINER environments</li>
                    <li>Implement automated scanning and remediation workflows</li>
                    <li>Develop incident response procedures for zero-day vulnerabilities</li>
                    <li>Regular security awareness training focusing on current threat landscape</li>
                </ul>
            </div>
        </div>

        <div class="section">
            <h2>üìä Data Sources & Methodology</h2>
            <p><strong>Data Source:</strong> WIZ Security Platform</p>
            <p><strong>Analysis Period:</strong> Current snapshot as of {datetime.now().strftime('%Y-%m-%d')}</p>
            <p><strong>Risk Scoring:</strong> Based on CVSS scores, exploitability, and asset criticality</p>
            <p><strong>Coverage:</strong> Cloud and Container infrastructure</p>
        </div>
    </div>
</body>
</html>
"""
        
        return html_content

def main():
    """Main function to generate the executive report"""
    
    print("=" * 80)
    print("üõ°Ô∏è  Vulnerability Executive Report Generator")
    print("   Phoenix Security Configuration System")
    print("=" * 80)
    print()
    
    # Initialize analyzer
    csv_path = "/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/large_vulnerabilities.csv"
    
    try:
        print("üìä Loading vulnerability data...")
        analyzer = VulnerabilityAnalyzer(csv_path)
        
        print("üìà Generating analysis and visualizations...")
        analyzer.create_visualizations()
        
        print("üìÑ Generating HTML executive report...")
        html_report = analyzer.generate_html_report()
        
        # Save HTML report
        report_path = "/Users/francescocipollone/Documents/GitHub/autoconfig-priv/Utils/vulnerability translator/vulnerability_executive_report.html"
        with open(report_path, 'w', encoding='utf-8') as f:
            f.write(html_report)
        
        print(f"‚úÖ Executive report generated successfully!")
        print(f"üìÑ Report saved to: {report_path}")
        print(f"üìä Visualizations saved in the same directory")
        
        # Print summary statistics
        summary = analyzer.generate_executive_summary()
        print(f"\nüìã Quick Summary:")
        print(f"   ‚Ä¢ Total Vulnerabilities: {summary['total_vulnerabilities']:,}")
        print(f"   ‚Ä¢ Critical Vulnerabilities: {summary['critical_vulnerabilities']}")
        print(f"   ‚Ä¢ Average Risk Score: {summary['average_risk_score']}")
        print(f"   ‚Ä¢ Assets Affected: {summary['total_assets_affected']:,}")
        print(f"   ‚Ä¢ Remediation Rate: {summary['remediation_rate']}%")
        
    except FileNotFoundError:
        print(f"‚ùå Error: CSV file not found at {csv_path}")
        print("Please ensure the vulnerability data has been converted to CSV format first.")
    except Exception as e:
        print(f"‚ùå Error generating report: {e}")

if __name__ == "__main__":
    main()
